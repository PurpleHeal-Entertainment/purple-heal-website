// ========================================
// Purple Heal Admin - Panel Management
// ========================================

// Toast notification system
function showToast(message, type = 'success') {
    // Remove existing toast if any
    const existingToast = document.getElementById('admin-toast');
    if (existingToast) existingToast.remove();

    // Create toast container if doesn't exist
    let container = document.getElementById('toast-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        `;
        document.body.appendChild(container);
    }

    // Create toast element
    const toast = document.createElement('div');
    toast.id = 'admin-toast';

    const colors = {
        success: { bg: '#1a1a2e', border: '#9B59B6', icon: '‚úÖ' },
        error: { bg: '#1a1a2e', border: '#e74c3c', icon: '‚ùå' },
        warning: { bg: '#1a1a2e', border: '#f39c12', icon: '‚ö†Ô∏è' },
        info: { bg: '#1a1a2e', border: '#3498db', icon: '‚ÑπÔ∏è' }
    };

    const config = colors[type] || colors.success;

    toast.style.cssText = `
        background: ${config.bg};
        border: 2px solid ${config.border};
        border-radius: 12px;
        padding: 16px 24px;
        color: white;
        font-family: 'Oxanium', sans-serif;
        font-size: 14px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        gap: 12px;
        animation: slideIn 0.3s ease-out;
        max-width: 400px;
    `;

    toast.innerHTML = `
        <span style="font-size: 20px;">${config.icon}</span>
        <span>${message.replace(/^[‚úÖ‚ùå‚ö†Ô∏è‚ÑπÔ∏è]\s*/, '')}</span>
        <button onclick="this.parentElement.remove()" style="
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.5);
            cursor: pointer;
            font-size: 18px;
            margin-left: 10px;
            padding: 0;
        ">√ó</button>
    `;

    // Add animation keyframes
    if (!document.getElementById('toast-styles')) {
        const style = document.createElement('style');
        style.id = 'toast-styles';
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }

    container.appendChild(toast);

    // Auto remove after 4 seconds
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-in forwards';
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}

// Tab switching
function switchTab(tabName) {
    // Remove active class from all tabs and contents
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

    // Add active class to selected tab
    event.target.classList.add('active');
    document.getElementById(tabName + '-tab').classList.add('active');
}

// Storage functions - Using IndexedDB for unlimited storage
async function saveArtists(artists) {
    console.log('saveArtists called with:', artists);
    console.log('Is array?', Array.isArray(artists));
    console.log('Length:', artists?.length);

    try {
        console.log('Calling saveArtistsDB...');
        await saveArtistsDB(artists);
        console.log('saveArtistsDB completed successfully ‚úÖ');
        return true;
    } catch (error) {
        console.error('‚ùå Error in saveArtists:', error);
        showToast('Error al guardar artistas. Por favor recarga la p√°gina.', 'error');
        return false;
    }
}

async function loadArtists() {
    try {
        const artists = await loadArtistsDB();
        console.log('‚úÖ Artists loaded from IndexedDB:', artists?.length || 0, 'artists');
        return artists || [];
    } catch (error) {
        console.error('‚ùå Error loading artists:', error);
        return [];
    }
}

// Initialize admin panel
async function initAdmin() {
    try {
        console.log('üöÄ initAdmin called');

        // Wait a bit to ensure DB is initialized
        await new Promise(resolve => setTimeout(resolve, 100));

        const artists = await loadArtists();
        console.log('‚úÖ Loaded artists:', artists?.length || 0, 'artists');

        renderArtistsList(artists);
    } catch (error) {
        console.error('‚ùå Error in initAdmin:', error);
        showToast('Error al cargar el panel. Por favor recarga la p√°gina.', 'error');
    }
}

// Render artists list
function renderArtistsList(artists) {
    const container = document.getElementById('artists-list');
    if (!container) {
        console.warn('‚ö†Ô∏è artists-list container not found');
        return;
    }

    console.log('üìù Rendering artists list:', artists?.length || 0);

    if (!artists || artists.length === 0) {
        container.innerHTML = '<p style="color: var(--ph-gray-lighter); text-align: center;">No hay artistas. Agrega uno nuevo.</p>';
        return;
    }

    container.innerHTML = artists.map((artist, index) => `
        <div class="artist-item">
            <div>
                <h3>${artist.name}</h3>
                <p style="color: var(--ph-gray-lighter); font-size: var(--fs-sm); margin-top: var(--space-xs);">
                    ${artist.genre || 'Sin g√©nero'} | ${artist.albums?.length || 0} √°lbumes | ${artist.merch?.length || 0} productos
                </p>
            </div>
            <div style="display: flex; gap: var(--space-sm);">
                <button onclick="editArtist(${index})" class="ph-button ph-button--outline" style="padding: var(--space-sm) var(--space-md);">
                    EDITAR
                </button>
                <button onclick="deleteArtist(${index})" class="ph-button ph-button--outline" style="padding: var(--space-sm) var(--space-md); border-color: #e74c3c; color: #e74c3c;">
                    ELIMINAR
                </button>
            </div>
        </div>
    `).join('');
}

// Delete artist
async function deleteArtist(index) {
    const password = prompt('‚ö†Ô∏è ¬øEstas completamente seguro? Esta accion eliminara el artista Y TODOS SUS ALBUMES Y MERCHANDISING. NO se puede deshacer.\n\nEscribe la contrase√±a de administrador para confirmar:');

    if (password === 'admin123') {
        const artists = await loadArtists();
        artists.splice(index, 1);
        await saveArtists(artists);
        showToast('Artista eliminado exitosamente.');
        renderArtistsList(artists);
    } else {
        showToast('Contrase√±a incorrecta. Artista no eliminado.', 'error');
    }
}

// Show add artist form
function showAddArtistForm() {
    // Hide artists list card
    const artistsCard = document.querySelector('#artists-tab > .ph-card');
    if (artistsCard) artistsCard.style.display = 'none';

    // Show add artist form
    const formContainer = document.getElementById('add-artist-form-container');
    if (formContainer) formContainer.style.display = 'block';

    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Hide add artist form and show list
function hideAddArtistForm() {
    // Show artists list card
    const artistsCard = document.querySelector('#artists-tab > .ph-card');
    if (artistsCard) artistsCard.style.display = 'block';

    // Hide add artist form
    const formContainer = document.getElementById('add-artist-form-container');
    if (formContainer) formContainer.style.display = 'none';

    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Edit artist
async function editArtist(index) {
    const artists = await loadArtists();
    const artist = artists[index];

    // Show artist profile view
    showArtistProfile(artist, index);
}

// Show artist profile
function showArtistProfile(artist, artistIndex) {
    const artistsList = document.getElementById('artists-list');
    const addArtistBtn = document.querySelector('button[onclick="showAddArtistForm()"]');

    if (artistsList) artistsList.style.display = 'none';
    if (addArtistBtn) addArtistBtn.style.display = 'none';

    const artistView = document.getElementById('artist-view') || createArtistView();

    artistView.style.display = 'block';
    artistView.innerHTML = `
        <div class="ph-card">
            <div class="ph-card__content">
                <button onclick="closeArtistView()" class="ph-button ph-button--outline" style="margin-bottom: var(--space-lg);">
                    ‚Üê VOLVER A LA LISTA
                </button>
                
                <h2 style="margin-bottom: var(--space-xl); color: var(--ph-purple-lighter);">PERFIL DE ARTISTA</h2>
                
                <!-- Basic Info Form -->
                <form id="artist-form" onsubmit="saveArtistProfile(event, ${artistIndex})" style="margin-bottom: var(--space-3xl);">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg);">
                        <div class="form-group">
                            <label for="artist-name">Nombre del Artista *</label>
                            <input type="text" id="artist-name" value="${artist.name || ''}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="artist-genre">Genero Musical *</label>
                            <input type="text" id="artist-genre" value="${artist.genre || ''}" placeholder="Ej: Pop Latino / K-Pop" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="artist-bio">Biografia</label>
                        <textarea id="artist-bio" rows="4">${artist.bio || ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="artist-image">Imagen del Artista</label>
                        <input type="file" id="artist-image" accept="image/*" onchange="previewArtistImage(event)">
                        ${artist.image ? `<img id="artist-image-preview" src="${artist.image}" style="max-width: 200px; margin-top: var(--space-md); border-radius: var(--radius-md);">` : '<img id="artist-image-preview" style="display:none; max-width: 200px; margin-top: var(--space-md); border-radius: var(--radius-md);">'}
                    </div>
                    
                    <button type="submit" class="ph-button ph-button--primary" style="width: 100%;">
                        ACTUALIZAR INFORMACION DEL ARTISTA
                    </button>
                </form>
                
                <!-- Albums Section -->
                <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: var(--space-2xl); margin-top: var(--space-2xl);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                        <h3 style="color: var(--ph-purple-lighter);">ALBUMES</h3>
                        <button onclick="showAlbumForm(${artistIndex}, null)" class="ph-button ph-button--primary">
                            + AGREGAR ALBUM
                        </button>
                    </div>
                    <div id="artist-albums-list">
                        ${renderArtistAlbums(artist, artistIndex)}
                    </div>
                </div>
                
                <!-- Merch Section -->
                <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: var(--space-2xl); margin-top: var(--space-2xl);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                        <h3 style="color: var(--ph-purple-lighter);">MERCHANDISING</h3>
                        <button onclick="showMerchForm(${artistIndex}, null)" class="ph-button ph-button--primary">
                            + AGREGAR PRODUCTO
                        </button>
                    </div>
                    <div id="artist-merch-list">
                        ${renderArtistMerch(artist, artistIndex)}
                    </div>
                </div>
            </div>
        </div>
    `;
}

function createArtistView() {
    const view = document.createElement('div');
    view.id = 'artist-view';
    view.style.display = 'none';
    document.getElementById('artists-tab').appendChild(view);
    return view;
}

function closeArtistView() {
    const artistView = document.getElementById('artist-view');
    const artistsList = document.getElementById('artists-list');
    const addArtistBtn = document.querySelector('button[onclick="showAddArtistForm()"]');

    if (artistView) artistView.style.display = 'none';
    if (artistsList) artistsList.style.display = 'block';
    if (addArtistBtn) addArtistBtn.style.display = 'block';
}

// Preview artist image
let currentArtistImage = null;

function previewArtistImage(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
            currentArtistImage = e.target.result;
            const preview = document.getElementById('artist-image-preview');
            if (preview) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            }
        };
        reader.readAsDataURL(file);
    }
}

// Save artist profile
async function saveArtistProfile(event, artistIndex) {
    event.preventDefault();

    const artists = await loadArtists();
    const artist = artists[artistIndex];

    artist.name = document.getElementById('artist-name').value;
    artist.genre = document.getElementById('artist-genre').value;
    artist.bio = document.getElementById('artist-bio').value;

    if (currentArtistImage) {
        artist.image = currentArtistImage;
    }

    await saveArtists(artists);
    showToast('Artista actualizado exitosamente!');
    currentArtistImage = null;
}

// Render artist albums
function renderArtistAlbums(artist, artistIndex) {
    const albums = artist.albums || [];

    if (albums.length === 0) {
        return '<p style="color: var(--ph-gray-lighter);">No hay √°lbumes. Agrega uno nuevo.</p>';
    }

    return albums.map((album, albumIndex) => {
        // Parse date properly to avoid timezone issues
        let formattedDate = '';
        if (album.releaseDate) {
            const [year, month, day] = album.releaseDate.split('-');
            const date = new Date(year, month - 1, day);
            formattedDate = date.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
        } else if (album.year) {
            formattedDate = album.year;
        }

        return `
        <div class="artist-item" style="margin-bottom: var(--space-md);">
            <div style="display: flex; gap: var(--space-md); align-items: center;">
                ${album.images && album.images[0] ?
                `<img src="${album.images[0]}" style="width: 80px; height: 80px; object-fit: cover; border-radius: var(--radius-sm);">` :
                '<div style="width: 80px; height: 80px; background: var(--ph-gray-darker); border-radius: var(--radius-sm);"></div>'
            }
                <div>
                    <h4 style="margin: 0; color: var(--ph-white);">${album.title}</h4>
                    <p style="color: var(--ph-gray-lighter); font-size: var(--fs-sm); margin-top: var(--space-xs);">
                        ${album.type} | ${formattedDate} | $${album.price}
                    </p>
                </div>
            </div>
            <div style="display: flex; gap: var(--space-sm);">
                <button onclick="showAlbumForm(${artistIndex}, ${albumIndex})" class="ph-button ph-button--outline" style="padding: var(--space-sm) var(--space-md); display: flex; align-items: center; justify-content: center;">
                    EDITAR
                </button>
                <button onclick="deleteAlbum(${artistIndex}, ${albumIndex})" class="ph-button ph-button--outline" style="padding: var(--space-sm) var(--space-md); border-color: #e74c3c; color: #e74c3c; display: flex; align-items: center; justify-content: center;">
                    ELIMINAR
                </button>
            </div>
        </div>
    `}).join('');
}

// Render artist merch
function renderArtistMerch(artist, artistIndex) {
    const merch = artist.merch || [];

    if (merch.length === 0) {
        return '<p style="color: var(--ph-gray-lighter);">No hay productos. Agrega uno nuevo.</p>';
    }

    return merch.map((product, productIndex) => `
        <div class="artist-item" style="margin-bottom: var(--space-md);">
            <div style="display: flex; gap: var(--space-md); align-items: center;">
                ${product.images && product.images[0] ?
            `<img src="${product.images[0]}" style="width: 80px; height: 80px; object-fit: cover; border-radius: var(--radius-sm);">` :
            '<div style="width: 80px; height: 80px; background: var(--ph-gray-darker); border-radius: var(--radius-sm);"></div>'
        }
                <div>
                    <h4 style="margin: 0; color: var(--ph-white);">${product.name}</h4>
                    <p style="color: var(--ph-gray-lighter); font-size: var(--fs-sm); margin-top: var(--space-xs);">
                        ${product.category || 'Producto'} | $${product.price}
                    </p>
                </div>
            </div>
            <div style="display: flex; gap: var(--space-sm);">
                <button onclick="showMerchForm(${artistIndex}, ${productIndex})" class="ph-button ph-button--outline" style="padding: var(--space-sm) var(--space-md);">
                    EDITAR
                </button>
                <button onclick="deleteMerch(${artistIndex}, ${productIndex})" class="ph-button ph-button--outline" style="padding: var(--space-sm) var(--space-md); border-color: #e74c3c; color: #e74c3c;">
                    ELIMINAR
                </button>
            </div>
        </div>
    `).join('');
}

// Delete album
async function deleteAlbum(artistIndex, albumIndex) {
    const password = prompt('¬øSeguro que deseas eliminar este √°lbum? Esta acci√≥n no se puede deshacer.\n\nEscribe la contrase√±a de administrador para confirmar:');

    if (password === 'admin123') {
        const artists = await loadArtists();
        artists[artistIndex].albums.splice(albumIndex, 1);
        await saveArtists(artists);
        showToast('√Ålbum eliminado exitosamente.');
        showArtistProfile(artists[artistIndex], artistIndex);
    } else {
        showToast('Contrase√±a incorrecta. √Ålbum no eliminado.', 'error');
    }
}

// Delete merch
async function deleteMerch(artistIndex, productIndex) {
    const password = prompt('¬øSeguro que deseas eliminar este producto? Esta acci√≥n no se puede deshacer.\n\nEscribe la contrase√±a de administrador para confirmar:');

    if (password === 'admin123') {
        const artists = await loadArtists();
        artists[artistIndex].merch.splice(productIndex, 1);
        await saveArtists(artists);
        showToast('Producto eliminado exitosamente.');
        showArtistProfile(artists[artistIndex], artistIndex);
    } else {
        showToast('Contrase√±a incorrecta. Producto no eliminado.', 'error');
    }
}

// Show album form
let tempAlbumImages = [];


async function showAlbumForm(artistIndex, albumIndex) {
    const artists = await loadArtists();
    const artist = artists[artistIndex];

    // Initialize albums array if it doesn't exist
    if (!artist.albums) {
        artist.albums = [];
        await saveArtists(artists);
    }

    const album = albumIndex !== null ? artist.albums[albumIndex] : null;

    tempAlbumImages = album?.images ? [...album.images] : [];

    const title = album ? 'EDITAR ALBUM' : 'AGREGAR ALBUM';

    const artistView = document.getElementById('artist-view');

    artistView.innerHTML = `
        <div class="ph-card" style="margin-bottom: var(--space-xl);">
            <div class="ph-card__content">
                <!-- Header with back button and title -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2xl);">
                    <button onclick="closeAlbumView()" class="ph-button ph-button--outline">
                        ‚Üê VOLVER AL PERFIL
                    </button>
                    <h2 style="margin: 0; color: var(--ph-purple-lighter);">${title}</h2>
                </div>
                
                <!-- Centered Artist Name -->
                <h1 style="margin-bottom: var(--space-3xl); color: var(--ph-white); font-size: var(--fs-3xl);">
                    ARTISTA: ${artist.name}
                </h1>
                
                <div style="display: grid; grid-template-columns: 500px 1fr; gap: 60px;">
                    
                    <!-- LEFT COLUMN: Album Images -->
                    <div>
                        <h3 style="margin-bottom: var(--space-md); color: var(--ph-purple-lighter);">IMAGENES DEL ALBUM</h3>
                        <p style="color: var(--ph-gray-lighter); font-size: var(--fs-sm); margin-bottom: var(--space-lg);">
                            Resoluci√≥n recomendada: 3000x3000px (formato 1:1)
                        </p>
                        
                        <div id="album-images-container" style="display: flex; flex-direction: column; gap: var(--space-md);">
                            ${renderAlbumImagePreviews(album, artistIndex, albumIndex)}
                        </div>
                        
                        <button type="button" onclick="addAlbumImageSlot(${artistIndex}, ${albumIndex})" 
                                id="add-album-image-btn"
                                class="ph-button ph-button--outline" 
                                style="width: 100%; margin-top: var(--space-md);">
                            + AGREGAR OTRA IMAGEN
                        </button>
                        <p style="color: var(--ph-gray-lighter); font-size: var(--fs-xs); text-align: center; margin-top: var(--space-sm);">
                            M√°ximo 15 im√°genes
                        </p>
                    </div>
                    
                    <!-- RIGHT COLUMN: Album Form -->
                    <div>
                        <form id="album-form" data-artist-index="${artistIndex}" data-album-index="${albumIndex}">
                            <style>
                                #album-form input,
                                #album-form select,
                                #album-form textarea {
                                    background: rgba(255, 255, 255, 0.05);
                                    border: 1px solid rgba(255, 255, 255, 0.2);
                                    border-radius: var(--radius-md);
                                    padding: var(--space-md);
                                    color: var(--ph-white);
                                    font-family: var(--font-body);
                                    font-size: var(--fs-base);
                                    transition: all var(--transition-base);
                                }
                                
                                #album-form select option {
                                    background: #1a1a1a;
                                    color: white;
                                }
                                
                                #album-form input:focus,
                                #album-form select:focus,
                                #album-form textarea:focus {
                                    outline: none;
                                    border-color: var(--ph-purple-primary);
                                    background: rgba(255, 255, 255, 0.08);
                                }
                                
                                #album-form input::placeholder,
                                #album-form textarea::placeholder {
                                    color: rgba(255, 255, 255, 0.4);
                                }
                            </style>
                            
                            <div class="form-group">
                                <label for="album-title">T√≠tulo del √Ålbum *</label>
                                <input type="text" id="album-title" name="title" 
                                       value="${album?.title || ''}" 
                                       placeholder="Ej: Mi Primer EP" 
                                       style="width: 100%; box-sizing: border-box;" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="album-releaseDate">Fecha de Lanzamiento *</label>
                                <input type="date" id="album-releaseDate" name="releaseDate" 
                                       value="${album?.releaseDate || album?.year ? (album?.releaseDate || `${album?.year}-01-01`) : ''}" 
                                       style="width: 100%; box-sizing: border-box;" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="album-price">Precio (USD) *</label>
                                <input type="number" id="album-price" name="price" 
                                       value="${album?.price || ''}" 
                                       placeholder="15.99" step="0.01" min="0"
                                       style="width: 100%; box-sizing: border-box;" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="album-type">Tipo *</label>
                                <select id="album-type" name="type" style="width: 100%; box-sizing: border-box;" required>
                                    <option value="EP" ${album?.type === 'EP' ? 'selected' : ''}>EP</option>
                                    <option value="LP" ${album?.type === 'LP' ? 'selected' : ''}>LP (√Ålbum completo)</option>
                                    <option value="Single" ${album?.type === 'Single' ? 'selected' : ''}>Single</option>
                                    <option value="Mixtape" ${album?.type === 'Mixtape' ? 'selected' : ''}>Mixtape</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="album-description">Descripci√≥n</label>
                                <textarea id="album-description" name="description" 
                                          rows="3" placeholder="Describe el √°lbum..."
                                          style="width: 100%; box-sizing: border-box; min-height: 80px; resize: vertical;"
                                          oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'">${album?.description || ''}</textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="album-stock">Estado</label>
                                <select id="album-stock" name="stock" style="width: 100%; box-sizing: border-box;">
                                    <option value="EN STOCK" ${album?.stock !== 'SOLD OUT' ? 'selected' : ''}>EN STOCK</option>
                                    <option value="SOLD OUT" ${album?.stock === 'SOLD OUT' ? 'selected' : ''}>SOLD OUT (Agotado)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="album-link">Link de Compra / Streaming</label>
                                <input type="url" id="album-link" name="link" 
                                       value="${album?.link || ''}" 
                                       placeholder="https://..."
                                       style="width: 100%; box-sizing: border-box;">
                            </div>
                            
                            <button type="submit" class="ph-button ph-button--primary" style="width: 100%; margin-top: var(--space-lg);">
                                ${album ? 'ACTUALIZAR ALBUM' : 'GUARDAR ALBUM'}
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Add form submit handler
    document.getElementById('album-form').addEventListener('submit', saveAlbumForm);
}

async function closeAlbumView() {
    const artists = await loadArtists();
    const form = document.getElementById('album-form');
    const artistIndex = parseInt(form.dataset.artistIndex);

    showArtistProfile(artists[artistIndex], artistIndex);
}

// Render album image previews
function renderAlbumImagePreviews(album, artistIndex, albumIndex) {
    const images = album?.images || [];
    let html = '';

    // First image - large
    const firstImage = images[0];
    html += `
        <div class="album-image-slot" style="position: relative; margin-bottom: var(--space-lg);">
            <div style="aspect-ratio: 1/1; background: var(--ph-gray-darker); border-radius: var(--border-radius); overflow: hidden; border: 2px dashed var(--ph-purple);">
                ${firstImage ? `
                    <img src="${firstImage}" style="width: 100%; height: 100%; object-fit: cover;">
                    <button type="button" onclick="removeAlbumImage(${artistIndex}, ${albumIndex}, 0)" 
                            style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 18px;">
                        √ó
                    </button>
                ` : `
                    <label for="album-image-0" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; cursor: pointer;">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--ph-purple-lighter)" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                        <p style="color: var(--ph-gray-lighter); margin-top: var(--space-sm); font-size: var(--fs-sm);">
                            Click para subir imagen principal
                        </p>
                    </label>
                    <input type="file" id="album-image-0" class="album-image-input" accept="image/*" 
                           style="display: none;" onchange="handleAlbumImageUpload(event, ${artistIndex}, ${albumIndex}, 0)">
                `}
            </div>
        </div>
    `;

    // Additional images - horizontal scroll thumbnails
    if (images.length > 1 || !firstImage) {
        html += `
            <div style="margin-top: var(--space-md);">
                <p style="color: var(--ph-gray-lighter); font-size: var(--fs-sm); margin-bottom: var(--space-sm);">Im√°genes adicionales:</p>
                <div style="display: flex; gap: var(--space-sm); overflow-x: auto; padding-bottom: var(--space-sm);">
        `;

        // Start from index 1 (skip first image)
        for (let i = 1; i < 15; i++) {
            const imageData = images[i];

            // Show existing images or some empty slots
            if (imageData || i < images.length + 3) {
                html += `
                    <div class="album-image-slot" style="position: relative; flex-shrink: 0; width: 120px;">
                        <div style="aspect-ratio: 1/1; background: var(--ph-gray-darker); border-radius: var(--border-radius); overflow: hidden; border: 1px dashed var(--ph-purple-lighter);">
                            ${imageData ? `
                                <img src="${imageData}" style="width: 100%; height: 100%; object-fit: cover;">
                                <button type="button" onclick="removeAlbumImage(${artistIndex}, ${albumIndex}, ${i})" 
                                        style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.9); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px;">
                                    √ó
                                </button>
                            ` : `
                                <label for="album-image-${i}" style="display: flex; align-items: center; justify-content: center; height: 100%; cursor: pointer;">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--ph-purple-lighter)" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                        <polyline points="21 15 16 10 5 21"></polyline>
                                    </svg>
                                </label>
                                <input type="file" id="album-image-${i}" class="album-image-input" accept="image/*" 
                                       style="display: none;" onchange="handleAlbumImageUpload(event, ${artistIndex}, ${albumIndex}, ${i})">
                            `}
                        </div>
                    </div>
                `;
            }
        }

        html += `
                </div>
            </div>
        `;
    }

    return html;
}

// Handle album image upload
function handleAlbumImageUpload(event, artistIndex, albumIndex, imageIndex) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
            tempAlbumImages[imageIndex] = e.target.result;
            const container = document.getElementById('album-images-container');
            container.innerHTML = renderAlbumImagePreviews({ images: tempAlbumImages }, artistIndex, albumIndex);
        };
        reader.readAsDataURL(file);
    }
}

// Remove album image
function removeAlbumImage(artistIndex, albumIndex, imageIndex) {
    tempAlbumImages.splice(imageIndex, 1);
    const container = document.getElementById('album-images-container');
    container.innerHTML = renderAlbumImagePreviews({ images: tempAlbumImages }, artistIndex, albumIndex);
}

// Add album image slot
function addAlbumImageSlot(artistIndex, albumIndex) {
    if (tempAlbumImages.length >= 15) {
        showToast('M√°ximo 15 im√°genes permitidas', 'warning');
        return;
    }
    const container = document.getElementById('album-images-container');
    container.innerHTML = renderAlbumImagePreviews({ images: tempAlbumImages }, artistIndex, albumIndex);
}

// Save album form
async function saveAlbumForm(event) {
    event.preventDefault();

    const form = event.target;
    const artistIndex = parseInt(form.dataset.artistIndex);
    const albumIndex = form.dataset.albumIndex !== 'null' ? parseInt(form.dataset.albumIndex) : null;

    // Validate required fields
    const title = document.getElementById('album-title').value.trim();
    const releaseDate = document.getElementById('album-releaseDate').value;
    const price = parseFloat(document.getElementById('album-price').value);
    const type = document.getElementById('album-type').value;

    if (!title || !releaseDate || !price || !type) {
        showToast('Por favor completa los campos obligatorios (*)', 'warning');
        return;
    }

    if (tempAlbumImages.length === 0) {
        showToast('Por favor agrega al menos una imagen', 'warning');
        return;
    }

    // Extract year from date for backward compatibility
    const year = releaseDate.split('-')[0];

    const albumData = {
        title,
        releaseDate,
        year, // Keep for backward compatibility
        price,
        type,
        description: document.getElementById('album-description').value.trim(),
        stock: document.getElementById('album-stock').value,
        link: document.getElementById('album-link').value.trim(),
        images: tempAlbumImages
    };

    const artists = await loadArtists();

    if (albumIndex === null) {
        // Add new album
        if (!artists[artistIndex].albums) {
            artists[artistIndex].albums = [];
        }
        artists[artistIndex].albums.push(albumData);
    } else {
        // Update existing album
        artists[artistIndex].albums[albumIndex] = albumData;
    }

    await saveArtists(artists);
    showToast(`√Ålbum "${albumData.title}" ${albumIndex === null ? 'agregado' : 'actualizado'} exitosamente!`);

    // Go back to artist profile
    showArtistProfile(artists[artistIndex], artistIndex);
}

// Show merch form
let tempMerchImages = [];

function showMerchForm(artistIndex, merchIndex) {
    // Similar implementation to showAlbumForm but for merchandise
    // This would be a large function, truncating for brevity
    showToast('Funci√≥n de merchandising en desarrollo', 'info');
}

